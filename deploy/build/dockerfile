FROM mcr.microsoft.com/dotnet/sdk:8.0-preview AS builder-back

VOLUME /packages
ENV NUGET_PACKAGES /packages

ARG MAIN_CSPROJ_PATH
ARG ROOT_FOLDER

ENV SRC /app

RUN mkdir ${SRC}
WORKDIR ${SRC}


# region optimize dotnet restore
COPY ${SLN_PATH} ${SRC}/
COPY ${ROOT_FOLDER}/Entrypoints/*/*.csproj ${SRC}/${ROOT_FOLDER}/Entrypoints
COPY ${ROOT_FOLDER}/Internal/*/*.csproj ${SRC}/${ROOT_FOLDER}/Internal
COPY ${ROOT_FOLDER}/Adapters/*/*.csproj ${SRC}/${ROOT_FOLDER}/Adapters/

WORKDIR ${SRC}/${ROOT_FOLDER}/Entrypoints
RUN find *.csproj | sed -e 's/.csproj//g' | xargs mkdir -p
RUN find *.csproj | sed -r -e 's/((.+).csproj)/.\/\1 .\/\2/g' | xargs -I % sh -c 'mv %'

WORKDIR ${SRC}/${ROOT_FOLDER}/Internal
RUN find *.csproj | sed -e 's/.csproj//g' | xargs mkdir -p
RUN find *.csproj | sed -r -e 's/((.+).csproj)/.\/\1 .\/\2/g' | xargs -I % sh -c 'mv %'

WORKDIR ${SRC}/${ROOT_FOLDER}/Adapters
RUN find *.csproj | sed -e 's/.csproj//g' | xargs mkdir -p
RUN find *.csproj | sed -r -e 's/((.+).csproj)/.\/\1 .\/\2/g' | xargs -I % sh -c 'mv %'
# endregion optimize dotnet restore



WORKDIR ${SRC}/${ROOT_FOLDER}
RUN dotnet restore ${MAIN_CSPROJ_PATH}

COPY ${ROOT_FOLDER} ${SRC}/${ROOT_FOLDER}

RUN dotnet publish ${MAIN_CSPROJ_PATH} --no-restore -o /app/out


# Building front
FROM --platform=linux/amd64 node:16 as builder-front

COPY front/package.json /front/
COPY front/yarn.lock /front/
RUN cd /front && yarn --immutable --immutable-cache --check-cache

COPY front /front/
RUN cd /front && yarn build


# Running
FROM mcr.microsoft.com/dotnet/aspnet:8.0-preview  AS production


# Set timezone to EUROPE/PARIS 
RUN apt-get update && apt-get install -y locales  \
&& localedef -i fr_FR -c -f UTF-8 -A /usr/share/locale/locale.alias fr_FR.UTF-8 \
&& ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime && dpkg-reconfigure -f noninteractive tzdata
ENV LANG fr_FR.utf8

# Install mongodump
RUN apt-get update \
    && apt-get install -y gnupg wget \
    && wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | apt-key add - \
    && echo "deb http://repo.mongodb.org/apt/debian bullseye/mongodb-org/4.4 main" | tee /etc/apt/sources.list.d/mongodb-org-4.4.list \
    && apt-get update \
    && apt-get install -y mongodb-database-tools

ARG ENTRY_DLL
ENV ENTRY_DLL ${ENTRY_DLL}

WORKDIR /back
COPY --from=builder-back /app/out .

COPY --from=builder-front /front/build /back/wwwroot
ENV FRONT_PATH /back/wwwroot

EXPOSE 4000
CMD dotnet ${ENTRY_DLL}